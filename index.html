<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WOL Manager</title>
    <style>
        :root {
            --bg-color: #222; --card-bg: #333; --text-color: #eee; --gray-text: #888;
            --primary-color: #007bff; --primary-hover: #0056b3; --danger-color: #dc3545;
            --success-color: #28a745; --border-radius: 12px;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; text-align: center; padding: 20px; background-color: var(--bg-color); color: var(--text-color); margin: 0; }
        .container { max-width: 500px; margin: auto; }
        h1 { display: flex; align-items: center; justify-content: center; gap: 10px; }
        .add-btn { background-color: var(--success-color); color: white; border: none; padding: 10px 20px; font-size: 1rem; border-radius: 8px; cursor: pointer; transition: 0.2s; margin-bottom: 20px; }
        .device-list { display: flex; flex-direction: column; gap: 15px; text-align: left;}
        .device-card { background-color: var(--card-bg); padding: 20px; border-radius: var(--border-radius); display: flex; align-items: center; justify-content: space-between; gap: 15px;}
        .device-info { flex-grow: 1; }
        .device-name { font-weight: bold; font-size: 1.1rem; }
        .device-mac { font-size: 0.8rem; color: var(--gray-text); word-break: break-all;}
        .actions { display: flex; gap: 10px; }
        .actions button { color: white; border: none; padding: 10px; font-size: 1rem; border-radius: 8px; cursor: pointer; transition: 0.2s; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
        .wake-btn { background-color: var(--primary-color); }
        .edit-btn { background-color: #ffc107; }
        .delete-btn { background-color: var(--danger-color); }
        button:active { transform: scale(0.95); }
        #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #333; color: white; padding: 10px 20px; border-radius: 8px; visibility: hidden; opacity: 0; transition: opacity 0.5s, visibility 0.5s; }
        #toast.show { visibility: visible; opacity: 1; }
        /* Modal */
        .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: var(--card-bg); margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 400px; border-radius: var(--border-radius); }
        .modal-content h2 { margin-top: 0; }
        .modal-content input { width: calc(100% - 20px); padding: 10px; margin-bottom: 15px; border-radius: 5px; border: 1px solid var(--gray-text); background-color: #444; color: var(--text-color); }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; }
        .modal-buttons button { border-radius: 8px; padding: 10px 15px; border: none; cursor: pointer; }
        #save-btn { background-color: var(--primary-color); color: white; }
        #cancel-btn { background-color: #6c757d; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ–¥ï¸ WOL Manager</h1>
        <button class="add-btn" onclick="openModal()">+ æ–°è¦ãƒ‡ãƒã‚¤ã‚¹è¿½åŠ </button>
        <div id="device-list" class="device-list"></div>
    </div>

    <!-- The Modal -->
    <div id="device-modal" class="modal">
        <div class="modal-content">
            <h2 id="modal-title">ãƒ‡ãƒã‚¤ã‚¹ã®è¿½åŠ </h2>
            <input type="hidden" id="device-id">
            <input type="text" id="device-name" placeholder="ãƒ‡ãƒã‚¤ã‚¹å (ä¾‹: ãƒ¡ã‚¤ãƒ³PC)" required>
            <input type="text" id="device-mac" placeholder="MACã‚¢ãƒ‰ãƒ¬ã‚¹ (ä¾‹: 00:1A:2B:3C:4D:5E)" required>
            <div class="modal-buttons">
                <button id="cancel-btn" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="save-btn" onclick="saveDevice()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div id="toast"></div>

    <script>
        const deviceList = document.getElementById('device-list');
        const modal = document.getElementById('device-modal');
        const modalTitle = document.getElementById('modal-title');
        const deviceIdInput = document.getElementById('device-id');
        const deviceNameInput = document.getElementById('device-name');
        const deviceMacInput = document.getElementById('device-mac');

        // --- Toast ---
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.backgroundColor = isError ? 'var(--danger-color)' : 'var(--success-color)';
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 3000);
        }

        // --- Modal ---
        function openModal(device = null) {
            modalTitle.textContent = device ? 'ãƒ‡ãƒã‚¤ã‚¹ã®ç·¨é›†' : 'ãƒ‡ãƒã‚¤ã‚¹ã®è¿½åŠ ';
            deviceIdInput.value = device ? device.id : '';
            deviceNameInput.value = device ? device.name : '';
            deviceMacInput.value = device ? device.mac : '';
            modal.style.display = "block";
        }
        function closeModal() {
            modal.style.display = "none";
        }
        window.onclick = function(event) {
            if (event.target == modal) {
                closeModal();
            }
        }

        // --- API Calls ---
        async function fetchDevices() {
            try {
                const response = await fetch('/api/devices');
                if (!response.ok) throw new Error('Failed to fetch');
                const devices = await response.json();
                renderDevices(devices || []);
            } catch (error) {
                showToast('ãƒ‡ãƒã‚¤ã‚¹ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', true);
            }
        }

        async function saveDevice() {
            const id = deviceIdInput.value;
            const device = {
                name: deviceNameInput.value,
                mac: deviceMacInput.value,
            };
            if (!device.name || !device.mac) {
                showToast('åå‰ã¨MACã‚¢ãƒ‰ãƒ¬ã‚¹ã¯å¿…é ˆã§ã™ã€‚', true);
                return;
            }

            const url = id ? `/api/devices/${id}` : '/api/devices';
            const method = id ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(device)
                });
                if (!response.ok) {
                     const errorData = await response.json();
                     throw new Error(errorData.error || 'Save failed');
                }
                showToast(`ãƒ‡ãƒã‚¤ã‚¹ã‚’${id ? 'æ›´æ–°' : 'è¿½åŠ '}ã—ã¾ã—ãŸã€‚`);
                closeModal();
                fetchDevices();
            } catch (error) {
                showToast(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, true);
            }
        }

        async function deleteDevice(id) {
            if (!confirm('æœ¬å½“ã«ã“ã®ãƒ‡ãƒã‚¤ã‚¹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            try {
                const response = await fetch(`/api/devices/${id}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('Failed to delete');
                showToast('ãƒ‡ãƒã‚¤ã‚¹ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
                fetchDevices();
            } catch (error) {
                showToast('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', true);
            }
        }

        async function wakeDevice(id, name) {
            showToast(`ã€Œ${name}ã€ã«èµ·å‹•ä¿¡å·ã‚’é€ä¿¡ä¸­...`);
            try {
                const response = await fetch(`/api/wakeup/${id}`, { method: 'POST' });
                if (!response.ok) throw new Error('Failed to send magic packet');
                showToast(`ã€Œ${name}ã€ã«èµ·å‹•ä¿¡å·ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼ğŸš€`);
            } catch (error) {
                showToast('ä¿¡å·ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', true);
            }
        }

        // --- Rendering ---
        function renderDevices(devices) {
            deviceList.innerHTML = '';
            if (devices.length === 0) {
                deviceList.innerHTML = '<p style="text-align: center; color: var(--gray-text);">ãƒ‡ãƒã‚¤ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“ã€‚è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>';
                return;
            }
            devices.forEach(device => {
                const card = document.createElement('div');
                card.className = 'device-card';
                card.innerHTML = `
                    <div class="device-info">
                        <div class="device-name">${escapeHTML(device.name)}</div>
                        <div class="device-mac">${escapeHTML(device.mac)}</div>
                    </div>
                    <div class="actions">
                        <button class="wake-btn" title="èµ·å‹•">ğŸš€</button>
                        <button class="edit-btn" title="ç·¨é›†">âœï¸</button>
                        <button class="delete-btn" title="å‰Šé™¤">ğŸ—‘ï¸</button>
                    </div>
                `;
                card.querySelector('.wake-btn').onclick = () => wakeDevice(device.id, device.name);
                card.querySelector('.edit-btn').onclick = () => openModal(device);
                card.querySelector('.delete-btn').onclick = () => deleteDevice(device.id);
                deviceList.appendChild(card);
            });
        }
        
        function escapeHTML(str) {
            return str.replace(/[&<>"']/g, function(match) {
                return {
                    '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
                }[match];
            });
        }


        // Initial load
        document.addEventListener('DOMContentLoaded', fetchDevices);
    </script>
</body>
</html>
